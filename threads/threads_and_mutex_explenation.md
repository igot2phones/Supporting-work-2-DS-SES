# Τεκμηρίωση για Threads και Ανάλυση Κώδικα με Mutex

## Εισαγωγή στα Threads

Τα **threads** (νήματα) είναι μονάδες εκτέλεσης μέσα σε μια διαδικασία. Κάθε διαδικασία μπορεί να περιέχει ένα ή περισσότερα νήματα, τα οποία μπορούν να εκτελούνται ταυτόχρονα. Η χρήση πολλαπλών νημάτων επιτρέπει στην εφαρμογή να πραγματοποιεί πολλαπλές εργασίες παράλληλα, βελτιώνοντας την απόδοση και την απόκριση της εφαρμογής.

### Σκοπός των Threads

- **Παράλληλη Εκτέλεση**: Επιτρέπουν την εκτέλεση πολλαπλών εργασιών ταυτόχρονα, εκμεταλλευόμενοι πολλαπλούς πυρήνες επεξεργαστή.
- **Βελτιωμένη Απόδοση**: Μειώνουν τον χρόνο ολοκλήρωσης εργασιών που μπορούν να εκτελεστούν παράλληλα.
- **Καλύτερη Αξιοποίηση Πόρων**: Επιτρέπουν την αποτελεσματικότερη χρήση των διαθέσιμων πόρων του συστήματος.

## Ανάλυση Κώδικα

Παρακάτω παρουσιάζεται ένας αναλυτικός έλεγχος του αρχείου `3ThreadsExampleWithWait.c`.

### Ενσωματώσεις και Ορισμοί

```c
#include <stdio.h> 
#include <pthread.h> 
#include <unistd.h> 

#define NUM_THREADS 4 // Ορισμός του αριθμού των νημάτων
```

- **`#include <stdio.h>`**: Ενσωματώνει τη βιβλιοθήκη εισόδου/εξόδου.
- **`#include <pthread.h>`**: Ενσωματώνει τη βιβλιοθήκη για τη δημιουργία και διαχείριση νημάτων.
- **`#include <unistd.h>`**: Παρέχει πρόσβαση σε λειτουργίες POSIX.
- **`#define NUM_THREADS 4`**: Ορίζει τον αριθμό των νημάτων που θα δημιουργηθούν.

### Μεταβλητές Κοινής Χρήσης

```c
pthread_mutex_t mutex = PTHREAD_MUTEX_INITIALIZER; // Αρχικοποίηση του mutex
int shared_var = 0; // Κοινή μεταβλητή
int current_thread = 0; // Μεταβλητή για την παρακολούθηση του τρέχοντος νήματος
```

- **`pthread_mutex_t mutex`**: Δημιουργία και αρχικοποίηση ενός mutex για τον συγχρονισμό των νημάτων.
- **`int shared_var`**: Μια κοινή μεταβλητή που θα τροποποιείται από τα νήματα.
- **`int current_thread`**: Παρακολουθεί ποιο νήμα είναι το τρέχον για την εκτέλεση.

### Συνάρτηση Νήματος

```c
void* thread_func(void* arg) {
    int thread_num = *(int*)arg; // Απόκτηση του αριθμού του νήματος

    for(int i = 0; i < 2; i++) { // Κάθε νήμα εκτελείται δύο φορές για επίδειξη
        int done = 0; // Μεταβλητή για τον έλεγχο ολοκλήρωσης
        while(!done) {
            // Κλείδωμα του mutex
            pthread_mutex_lock(&mutex);
            
            if(current_thread == thread_num) { // Έλεγχος αν είναι η σειρά του νήματος
                shared_var += 1; // Αύξηση της κοινής μεταβλητής
                printf("I am thread %d and I got: %d\n", thread_num + 1, shared_var); // Εκτύπωση του αποτελέσματος
                current_thread = (current_thread + 1) % NUM_THREADS; // Ενημέρωση του τρέχοντος νήματος
                done = 1; // Ολοκλήρωση της εργασίας
            }

            // Ξεκλείδωμα του mutex
            pthread_mutex_unlock(&mutex);
            
            if(!done) {
                usleep(10000); // Ύπνος για αποφυγή busy waiting
            }
        }
    }
    return 0; // Επιστροφή από τη συνάρτηση νήματος
}
```

#### Βήμα προς Βήμα Ανάλυση

1. **Λήψη Αριθμού Νήματος**:
    ```c
    int thread_num = *(int*)arg;
    ```
    Κάθε νήμα λαμβάνει τον μοναδικό του αριθμό από το όρισμα `arg`.

2. **Εκτέλεση Δικαιωμάτων**:
    ```c
    for(int i = 0; i < 2; i++) {
    ```
    Κάθε νήμα εκτελεί το κύριο σώμα δύο φορές για επίδειξη.

3. **Διαδικασία Εκτέλεσης**:
    ```c
    while(!done) {
    ```
    Χρησιμοποιείται ένας βρόχος που συνεχίζεται μέχρι να ολοκληρωθεί η εργασία του νήματος.

4. **Κλείδωμα του Mutex**:
    ```c
    pthread_mutex_lock(&mutex);
    ```
    Το νήμα αποκτά τον αποκλεισμό του mutex για να εξασφαλίσει αποκλειστική πρόσβαση στην κοινή μεταβλητή.

5. **Έλεγχος Σειράς Νήματος**:
    ```c
    if(current_thread == thread_num) {
    ```
    Ελέγχει αν είναι η σειρά του τρέχοντος νήματος να εκτελέσει την εργασία.

6. **Τροποποίηση Κοινής Μεταβλητής**:
    ```c
    shared_var += 1;
    printf("I am thread %d and I got: %d\n", thread_num + 1, shared_var);
    ```
    Αυξάνει την κοινή μεταβλητή και εκτυπώνει το αποτέλεσμα.

7. **Ενημέρωση Τρέχοντος Νήματος**:
    ```c
    current_thread = (current_thread + 1) % NUM_THREADS;
    done = 1;
    ```
    Ενημερώνει ποιο νήμα είναι το επόμενο στην σειρά και σηματοδοτεί την ολοκλήρωση της εργασίας.

8. **Ξεκλείδωμα του Mutex**:
    ```c
    pthread_mutex_unlock(&mutex);
    ```
    Απελευθερώνει τον mutex για να επιτρέψει σε άλλα νήματα να αποκτήσουν πρόσβαση.

9. **Αποφυγή Busy Waiting**:
    ```c
    if(!done) {
        usleep(10000);
    }
    ```
    Αν η εργασία δεν ολοκληρώθηκε, το νήμα ύπνου για 10ms πριν ξαναδοκιμάσει.

### Δομή του Mutex και Χρήση

Ο **mutex** (αμοιβαίου αποκλεισμού) είναι ένας μηχανισμός συγχρονισμού που χρησιμοποιείται για την αποτροπή ταυτόχρονης πρόσβασης σε κοινόχρηστους πόρους από πολλαπλά νήματα. Στον κώδικα:

- **Αρχικοποίηση**:
    ```c
    pthread_mutex_t mutex = PTHREAD_MUTEX_INITIALIZER;
    ```
    Ο mutex αρχικοποιείται με την προκαθορισμένη ρύθμιση.

- **Κλείδωμα**:
    ```c
    pthread_mutex_lock(&mutex);
    ```
    Το νήμα αποκτά τον αποκλεισμό του mutex πριν από την τροποποίηση της κοινής μεταβλητής, εξασφαλίζοντας ότι κανένα άλλο νήμα δεν μπορεί να την τροποποιήσει ταυτόχρονα.

- **Ξεκλείδωμα**:
    ```c
    pthread_mutex_unlock(&mutex);
    ```
    Απελευθερώνει τον mutex μετά την ολοκλήρωση της τροποποίησης, επιτρέποντας σε άλλα νήματα να αποκτήσουν τον αποκλεισμό.

### Συμπεράσματα Ανάλυσης

Ο κώδικας δημιουργεί τέσσερα νήματα που επικοινωνούν μεταξύ τους μέσω μιας κοινής μεταβλητής `shared_var`. Ο mutex εξασφαλίζει ότι μόνο ένα νήμα κάθε φορά μπορεί να τροποποιήσει την κοινή μεταβλητή, αποφεύγοντας τις συνθήκες ανταγωνισμού (race conditions). Κάθε νήμα περιμένει τη σειρά του για να αυξήσει την μεταβλητή και να εκτυπώσει το αποτέλεσμα, δημιουργώντας μια ελεγχόμενη αλληλουχία εκτέλεσης.